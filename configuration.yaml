input_boolean:
  govee_heater_lr_state:
    name: Govee Heater LR State
    icon: mdi:radiator
  govee_heater_gb_state:
    name: Govee Heater GB State
    icon: mdi:radiator

rest_command:
  govee_appliance_request:
    url: https://openapi.api.govee.com/router/api/v1/device/control
    method: POST
    headers:
      Content-Type: application/json
      Govee-API-Key: !secret govee_api_key
    content_type: "application/json; charset=utf-8"
    payload: >-
      {
        "requestId": "{{ requestId }}",
        "payload": {
          "sku": "{{ sku }}",
          "device": "{{ device }}",
          "capability": {
            "type": "{{ capability_type }}",
            "instance": "{{ capability_instance }}",
            "value": {{ capability_value }}
          }
        }
      }

  govee_device_state:
    url: https://openapi.api.govee.com/router/api/v1/device/state
    method: POST
    headers:
      Content-Type: application/json
      Govee-API-Key: !secret govee_api_key
    content_type: "application/json; charset=utf-8"
    payload: >-
      {
        "requestId": "{{ requestId }}",
        "payload": {
          "sku": "{{ sku }}",
          "device": "{{ device }}"
        }
      }

switch:
  - platform: template
    switches:
      govee_heater_lr_toggle:
        value_template: '{{ states("input_boolean.govee_heater_lr_state") }}'
        friendly_name: "Govee Heater LR"
        turn_on:
          - service: script.govee_heater_lr_on
        turn_off:
          - service: script.govee_heater_lr_off
        icon_template: >-
          {% if is_state('input_boolean.govee_heater_lr_state', 'on') %} mdi:radiator
          {% else %} mdi:radiator-off
          {% endif %}
      govee_heater_gb_toggle:
        value_template: '{{ states("input_boolean.govee_heater_gb_state") }}'
        friendly_name: "Govee Heater GB"
        turn_on:
          - service: script.govee_heater_gb_on
        turn_off:
          - service: script.govee_heater_gb_off
        icon_template: >-
          {% if is_state('input_boolean.govee_heater_gb_state', 'on') %} mdi:radiator
          {% else %} mdi:radiator-off
          {% endif %}

sensor:
  - platform: rest
    name: "Govee Heater LR API State"
    method: POST
    resource: "https://openapi.api.govee.com/router/api/v1/device/state"
    headers:
      Content-Type: application/json
      Govee-API-Key: !secret govee_api_key
    payload: >-
      {
        "requestId": "lr_4",
        "payload": {
          "sku": "H7131",
          "device": "!secret govee_heater_lr_device"
        }
      }
    value_template: >-
      {% if value_json is defined and value_json.payload is defined and value_json.payload.capabilities is defined %}
        {% set power = value_json.payload.capabilities | selectattr('instance', 'equalto', 'powerSwitch') | map(attribute='state') | map(attribute='value') | first | default(0) %}
        {{ power }}
      {% else %}
        0
      {% endif %}
    scan_interval: 30
    force_update: true
    json_attributes_path: "$.payload.capabilities"
    json_attributes:
      - instance
      - type
      - state

  - platform: rest
    name: "Govee Heater GB API State"
    method: POST
    resource: "https://openapi.api.govee.com/router/api/v1/device/state"
    headers:
      Content-Type: application/json
      Govee-API-Key: !secret govee_api_key
    payload: >-
      {
        "requestId": "gb_4",
        "payload": {
          "sku": "H7131",
          "device": "!secret govee_heater_gb_device"
        }
      }
    value_template: >-
      {% if value_json is defined and value_json.payload is defined and value_json.payload.capabilities is defined %}
        {% set power = value_json.payload.capabilities | selectattr('instance', 'equalto', 'powerSwitch') | map(attribute='state') | map(attribute='value') | first | default(0) %}
        {{ power }}
      {% else %}
        0
      {% endif %}
    scan_interval: 30
    force_update: true
    json_attributes_path: "$.payload.capabilities"
    json_attributes:
      - instance
      - type
      - state